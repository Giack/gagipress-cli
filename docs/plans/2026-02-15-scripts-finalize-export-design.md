# Scripts Finalize & Export — Design Document

**Date:** 2026-02-15
**Approach:** Hybrid — export-ready now, publish-ready architecture for later

**Goal:** Close the workflow gap between script generation and content publication by adding script management commands, a finalize step, and calendar export.

**Current flow:** idea → script (text) → calendar → approve → STOP
**New flow:** idea → script → `scripts list` → `scripts finalize` → calendar plan (uses finalized) → approve → `calendar export` → manual publish

---

## New CLI Commands

### `gagipress scripts list [--status draft|finalized]`

- Shows all scripts: ID (truncated), idea description, platform hint (from duration), status, created date
- Optional `--status` filter
- Styled consistently with `ideas list` and `calendar show`

### `gagipress scripts finalize <id>`

- Accepts full ID or 6+ char prefix
- Verifies script exists and is in `draft` status
- Composes caption: `hook + "\n\n" + CTA + "\n\n" + hashtags`
- Shows styled preview in terminal
- Saves export file to `exports/<date>-<platform>-<short-id>.md`
- Updates script status: `draft` → `finalized`
- Updates idea status: `scripted` → `finalized`

### `gagipress calendar export <id> [--week]`

- Exports an approved calendar entry by resolving its associated script
- `--week` flag exports all approved entries for the current week
- Generates export files in same format as finalize

---

## Status Transitions

```
IDEA:     pending → approved → scripted → finalized
SCRIPT:   draft → finalized → used (future, when publish is implemented)
CALENDAR: pending_approval → approved → published (future)
```

---

## Data Model Changes

### `ContentScript` struct — add `Status` field

The DB already has a `status` column (default `draft`). The Go struct currently doesn't map it.

### New repository methods

1. `GetScriptByID(id)` — GET single script
2. `GetScriptByIDPrefix(prefix)` — RPC call to `find_script_by_prefix`
3. `UpdateScriptStatus(id, status)` — PATCH, same pattern as `UpdateIdeaStatus`
4. `GetScripts` — add optional `status` filter parameter

### Scheduler change

`PlanWeek` filters only scripts with `status = "finalized"` instead of all scripts.

---

## Export File Format

```markdown
# [Platform] Post — [Date]

## Caption
[hook]

[CTA]

[hashtags space-separated]

## Production Notes

**Music:** [audio_suggestion]
**Visual:** [visual_notes]
**Duration:** [estimated_duration]s

---
Generated by Gagipress CLI
```

### Directory: `exports/` (gitignored)

---

## New Migration

`004_find_script_by_prefix.sql` — PostgreSQL function `find_script_by_prefix(prefix_pattern text)`, same pattern as `find_idea_by_prefix` but on `content_scripts` table.

---

## Files to Create

- `cmd/scripts/scripts.go` — command group
- `cmd/scripts/list.go` — scripts list
- `cmd/scripts/finalize.go` — scripts finalize
- `cmd/calendar/export.go` — calendar export
- `migrations/004_find_script_by_prefix.sql`
- `supabase/migrations/004_find_script_by_prefix.sql`

## Files to Modify

- `internal/models/content.go` — add Status to ContentScript
- `internal/repository/content.go` — new methods + status filter on GetScripts
- `internal/scheduler/planner.go` — filter by finalized status
- `cmd/root.go` — register scripts command group
- `.gitignore` — add exports/

## Files NOT Modified

- `internal/generator/scripts.go` — stays as-is
- `internal/social/*` — placeholder for Phase 2
